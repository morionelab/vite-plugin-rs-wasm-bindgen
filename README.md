# vite-plugin-rs-wasm-bindgen

A vite plugin specific to Rust and wasm-bindgen.


## Features

- Wasm module integration.
- Automated executions of `cargo build` and `wasm-bindgen`.


## Requirements

- **rustc** and **cargo**
- the *rustc* target `wasm32-unknown-unknown`
  ```shell
  $ rustup target add wasm32-unknown-unknown
  ```
- **wasm-bindgen-cli** (Try `wasm-bindgen --version`)
  ```shell
  $ cargo install wasm-bindgen-cli
  ```


## Example

[`/examples`](/examples) contains working examples.

```js
// vite.config.js

import path from "node:path";
import { defineConfig } from "vite";
import rsWasmBindgen from "vite-plugin-rs-wasm-bindgen";

const rootDir = path.resolve(__dirname);
const manifestPath = path.join(rootDir, "path", "to", "Cargo.toml")

export default defineConfig({
    plugins: [
        rsWasmBindgen({
            verbose: true,
            targets: {
                "src/generated/wasm-module": manifestPath,
            },
        }),
    ],
})
```

```js
// src/index.js

import { wasm_fn } from "./generated/wasm-module";

// ad-hoc module for the init Promise
import init from "./generated/wasm-module?init";

init().then(() => {
    // call function from wasm
    wasm_fn();
})
```

## Options

See [`/doc/options.md`](/doc/options.md) for the complete description.

The field `modules` is mandatory to specify the modules to be processed,
which is an object as a mapping **from** a module path to be generated and bundled
**to** the wasm source (usually `Cargo.toml` path).

Setting `verbose` to true is useful to know what runs behind the plugin.

```typescript
type Options = {
    modules?: Record<string, ModuleOptions>;
    verbose?: boolean;
    redirectStderr?: boolean;

    skipBindgen?: boolean | "auto";
    skipBuild?: boolean | "auto";
    useDebugBuild?: boolean;
    useAwait?: boolean;
    watchRawWasm?: boolean;
};

type ModuleOptions = string |
{
    manifestPath?: string;
    rawWasmPath?: string;

    skipBindgen?: boolean | "auto";
    skipBuild?: boolean | "auto";
    useDebugBuild?: boolean;
    useAwait?: boolean;
    watchRawWasm?: boolean;
};
```

## WASM Initialization

Traditionally wasm modules require asynchronous fetching and instanctation.
The plugin provides **init promise** for each wasm module to ensure
the accessibility of the exported items. The *init promise* is returned
from a function exported from the virtual module as default.
The virtual module is named with the suffix `"?init"` to the module generated
by `wasm-bindgen`.

```javascript
import { hello } from "./gen/my-wasm"; // gen/my-wasm is generated by wasm-bindgen
                                       // as
                                       // - gen/my-wasm.js
                                       // - gen/my-wasm_bg.wasm
                                       // - gen/my-wasm_bg.js
import initWasm from "./gen/my-wasm?init"; // default export from the virtual module

const initPromise = initWasm();
initPromise().then((instance) => {  // the promise resolves WebAssembly.Instance
    hello();
});
```

### Workaround for Typescript

Typescript checker may warn against the import from the virtual module
like `"./gen/my-wasm?init"`.
Use intermediate .js and .d.ts files to work around these warnings.

```javascript
// my-wasm-init.js
export { default } from "./gen/my-wasm?init";
```

```typescript
// my-wasm-init.d.ts
export default function(): Promise<WebAssembly.Instance>
```

```javascript
import { hello } from "./gen/my-wasm";
import initWasm from "./my-wasm-init";

const initPromise = initWasm();
initPromise().then((instance) => {  // the promise resolves WebAssembly.Instance
    hello();
});
```

See the example `game-of-life` in [`/examples`](/examples).


### Top-level await

Alternatively, wasm modules can be imported synchronously using the *top-level await*
if the option `useAwait` is set to true.
This option requires the build target be `esnext` or higher than `es2022`.

```javascript
import { hello } from "./gen/my-wasm"; // gen/my-wasm is generated by wasm-bindgen
                                       // as
                                       // - gen/my-wasm.js
                                       // - gen/my-wasm_bg.wasm
                                       // - gen/my-wasm_bg.js

hello();
```

See the example `game-of-life-use-await` in [`/examples`](/examples).


## CLI Utilities

This plugin provide one npm command named `vite-rs-wasm-bindgen`.
This command executes `cargo build` and `wasm-bindgen` in the same way
as executed in `vite dev` or `vite build` according to `vite.config.js`
without starting dev server or building vite output.

```jsonc
{
    // ...
    "scripts": {
        // ...
        "dev": "vite dev",
        "build": "vite build",
        "bindgen": "vite-rs-wasm-bindgen",
        // ...
    }
    // ...
}
```
